<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper 
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="_loginLog">

    <sql id="dynamicWhere">
        <if test="@Ognl@isNotEmpty(searchVal)">
            <if test="searchKey == 1000">
                AND MGR_ID LIKE '%' || #{searchVal} || '%'
            </if>
            <if test="searchKey == 1001">
                AND MGR_NM LIKE '%' || #{searchVal} || '%'
            </if>
            <if test="searchKey == 1002">
                AND IP_ADDR LIKE '%' || #{searchVal} || '%'
            </if>
        </if>
        <if test="@Ognl@isNotEmpty(startDt)">
            AND LOGIN_DT &gt;= TO_DATE(#{startDt}, 'YYYYMMDDHH24MISS')
        </if>
        <if test="@Ognl@isNotEmpty(endDt)">
            AND LOGIN_DT &lt;= TO_DATE(#{endDt}, 'YYYYMMDDHH24MISS')
        </if>
    </sql>

    <select id="list" resultType="loginLogBean" parameterType="map">
        SELECT Y.* FROM (
            SELECT ROWNUM NUM, X.* FROM (       
                SELECT /*+ INDEX_DESC(CO_LOGIN_LOG) */
                       LOG_SEQ    AS logSeq,
                       MGR_ID     AS mgrId,
                       AGENCY_ID  AS agencyId,
                       IP_ADDR    AS ipAddr,
                       NVL(FN_MGR_NM(MGR_ID), '-') AS mgrNm,
                       FN_MGR_NM(AGENCY_ID) AS agencyNm,
                       TO_CHAR(LOGIN_DT, 'YYYY-MM-DD HH24:MI:SS') AS loginDt,
                       TO_CHAR(LOGOUT_DT, 'YYYY-MM-DD HH24:MI:SS') AS logOutDt
                  FROM CO_LOGIN_LOG
                 WHERE 1 = 1
                       <include refid="dynamicWhere" />
                ) X
            WHERE ROWNUM &lt;= #{pagingEndNum}
         ) Y
         WHERE NUM &gt;= #{pagingStartNum}
    </select>
    
    <select id="listCount" resultType="int" parameterType="map">
        SELECT COUNT(LOG_SEQ) AS totalCount
          FROM CO_LOGIN_LOG
         WHERE 1 = 1
               <include refid="dynamicWhere" />
    </select>
    
    <select id="listExcel" resultType="loginLogBean" parameterType="map">
        SELECT /*+ INDEX_DESC(CO_LOGIN_LOG) */
               LOG_SEQ    AS logSeq,
               MGR_ID     AS mgrId,
               AGENCY_ID  AS agencyId,
               IP_ADDR    AS ipAddr,
               FN_MGR_NM(MGR_ID) AS mgrNm,
               FN_MGR_NM(AGENCY_ID) AS agencyNm,
               TO_CHAR(LOGIN_DT, 'YYYY-MM-DD HH24:MI:SS') AS loginDt,
               TO_CHAR(LOGOUT_DT, 'YYYY-MM-DD HH24:MI:SS') AS logOutDt
          FROM CO_LOGIN_LOG
         WHERE 1 = 1
               <include refid="dynamicWhere" />
    </select>
    
    <insert id="login" parameterType="loginLogBean">
        INSERT INTO CO_LOGIN_LOG (
            LOG_SEQ,     MGR_ID,      AGENCY_ID,      IP_ADDR,     LOGIN_DT
        )
        VALUES (
            #{logSeq},   #{mgrId},    #{agencyId},    #{ipAddr},   SYSDATE
        )
    </insert>

    <update id="logout" parameterType="loginLogBean">
        UPDATE CO_LOGIN_LOG 
           SET LOGOUT_DT = SYSDATE
         WHERE LOG_SEQ = #{logSeq}
    </update>

</mapper>
